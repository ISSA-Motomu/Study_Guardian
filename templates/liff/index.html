<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Guardian Dashboard</title>
  <!-- LIFF SDK -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- Tailwind CSS (Play CDN for prototyping) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'M PLUS Rounded 1c', sans-serif;
      background-color: #f3f4f6;
      -webkit-tap-highlight-color: transparent;
    }

    .glass-panel {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .progress-bar {
      transition: width 1s ease-in-out;
    }
  </style>
</head>

<body>
  <div id="app" class="min-h-screen pb-20 max-w-md mx-auto relative overflow-hidden bg-slate-50">
    <!-- Header Background -->
    <div
      class="absolute top-0 left-0 w-full h-48 bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 rounded-b-[40px] z-0">
    </div>

    <!-- Main Content -->
    <div class="relative z-10 px-6 pt-8">
      <!-- Loading State -->
      <div v-if="loading" class="flex justify-center items-center h-64 text-white">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent"></div>
      </div>

      <div v-else>
        <!-- Avatar & Rank Section -->
        <div class="text-center mb-6">
          <div class="relative inline-block">
            <div class="w-24 h-24 mx-auto bg-white rounded-full p-1 shadow-xl">
              <img :src="user.avatar_url || 'https://via.placeholder.com/150'"
                class="w-full h-full rounded-full object-cover">
            </div>
            <div
              class="absolute -bottom-2 -right-2 bg-yellow-400 text-yellow-900 text-xs font-bold px-3 py-1 rounded-full shadow border-2 border-white">
              Lx.{{ user.level }}
            </div>
          </div>
          <h1 class="text-white text-xl font-bold mt-3 shadow-sm">{{ user.name }}</h1>
          <div class="inline-block bg-white/20 backdrop-blur-sm text-white text-xs px-3 py-1 rounded-full mt-1">
            {{ user.rank_name }}
          </div>
        </div>

        <!-- Main Stats Card -->
        <div class="glass-panel p-6 mb-6 transform transition-all hover:scale-[1.02]">
          <div class="flex justify-between items-center mb-4">
            <div class="text-gray-500 text-sm font-bold">TOTAL STUDY</div>
            <div class="text-indigo-600 text-2xl font-black">{{ user.total_hours }}<span
                class="text-sm text-gray-400 ml-1">h</span></div>
          </div>

          <!-- EXP Bar -->
          <div class="mb-2 flex justify-between text-xs font-bold text-gray-500">
            <span>EXP</span>
            <span>{{ user.exp }} / {{ user.next_exp }}</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-3 mb-6 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-400 to-indigo-500 h-3 rounded-full progress-bar"
              :style="{ width: expPercentage + '%' }"></div>
          </div>

          <!-- Coins -->
          <div class="flex items-center justify-between border-t border-gray-100 pt-4">
            <div class="flex items-center text-gray-600 font-bold">
              <span class="text-xl mr-2">ğŸ’°</span>
              <span>æ‰€æŒã‚³ã‚¤ãƒ³</span>
            </div>
            <div class="text-xl font-bold text-yellow-600">{{ user.coins.toLocaleString() }} G</div>
          </div>
        </div>

        <!-- Weekly Activity Chart (Mock) -->
        <div class="glass-panel p-5 mb-6">
          <h3 class="text-gray-700 font-bold mb-4 flex items-center">
            <span class="w-1 h-6 bg-pink-500 rounded-full mr-2"></span>
            ä»Šé€±ã®æ´»å‹•
          </h3>
          <div class="flex items-end justify-between h-32 px-2">
            <div v-for="(day, index) in weeklyData" :key="index" class="flex flex-col items-center w-1/7 group">
              <div class="relative w-3 bg-gray-100 rounded-t-sm h-full flex items-end overflow-hidden">
                <div class="w-full bg-pink-400 rounded-t-sm transition-all duration-500 group-hover:bg-pink-500"
                  :style="{ height: day.percent + '%' }"></div>
              </div>
              <span class="text-[10px] text-gray-400 mt-2 font-bold">{{ day.label }}</span>
            </div>
          </div>
        </div>

        <!-- Menu Grid -->
        <div class="grid grid-cols-2 gap-4 mb-20">
          <button @click="openShop"
            class="glass-panel p-4 flex flex-col items-center justify-center active:scale-95 transition-transform">
            <span class="text-3xl mb-2">ğŸ›’</span>
            <span class="font-bold text-gray-700">ã‚·ãƒ§ãƒƒãƒ—</span>
          </button>
          <button
            class="glass-panel p-4 flex flex-col items-center justify-center active:scale-95 transition-transform opacity-50">
            <span class="text-3xl mb-2">âš”ï¸</span>
            <span class="font-bold text-gray-700">æº–å‚™ä¸­</span>
          </button>
        </div>
        <!-- Study Start Modal -->
        <div v-if="showStudyModal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
          <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" @click="showStudyModal = false"></div>
          <div class="bg-white rounded-3xl p-6 w-full max-w-sm relative z-10 shadow-2xl overflow-hidden">
            <h3 class="text-xl font-bold text-center text-gray-800 mb-6">ä½•ã‚’å‹‰å¼·ã™ã‚‹ï¼Ÿ</h3>

            <div v-if="studying" class="text-center py-8">
              <div
                class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-t-transparent mx-auto mb-4">
              </div>
              <p class="text-gray-600 font-bold">æº–å‚™ä¸­...</p>
            </div>

            <div v-else class="grid grid-cols-2 gap-3">
              <button v-for="(color, subject) in subjects" :key="subject" @click="startStudy(subject)"
                class="relative h-24 rounded-2xl flex flex-col items-center justify-center shadow-sm active:scale-95 transition-transform overflow-hidden group">
                <div class="absolute inset-0 opacity-20 group-hover:opacity-30 transition-opacity"
                  :style="{ backgroundColor: color }"></div>
                <div class="text-2xl mb-1">ğŸ“–</div>
                <span class="font-bold text-gray-700">{{ subject }}</span>
                <div class="absolute bottom-0 left-0 w-full h-1" :style="{ backgroundColor: color }"></div>
              </button>
            </div>

            <button @click="showStudyModal = false"
              class="mt-6 w-full py-3 bg-gray-100 rounded-xl text-gray-500 font-bold active:bg-gray-200">
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
          </div>
        </div>

      </div>
    </div>

    <!-- Floating Action Button -->
    <button @click="openModal"
      class="fixed bottom-6 right-6 w-14 h-14 bg-indigo-600 rounded-full shadow-lg shadow-indigo-300 text-white flex items-center justify-center text-2xl active:scale-90 transition-transform z-50">
      <span>ğŸ“š</span>
    </button>
  </div>

  <script>
    const { createApp } = Vue

    // ç°¡æ˜“çš„ãªã‚µã‚¦ãƒ³ãƒ‰ç®¡ç†
    const sounds = {
      click: new Audio('/static/assets/sounds/click.mp3'),
      levelup: new Audio('/static/assets/sounds/levelup.mp3')
    };

    const playSound = (name) => {
      try {
        sounds[name].currentTime = 0;
        sounds[name].play().catch(e => console.log('Sound blocked'));
      } catch (e) { }
    }

    createApp({
      data() {
        return {
          loading: true,
          liffId: "2008998497-Vfli3v7u", // TODO: Set via backend
          user: {
            name: "Guest",
            level: 1,
            exp: 0,
            next_exp: 100,
            coins: 0,
            total_hours: 0,
            rank_name: "Beginner",
            avatar_url: ""
          },
          weeklyData: [
            { label: 'Mo', percent: 20 },
            { label: 'Tu', percent: 45 },
            { label: 'We', percent: 30 },
            { label: 'Th', percent: 80 },
            { label: 'Fr', percent: 10 },
            { label: 'Sa', percent: 90 },
            { label: 'Su', percent: 60 },
          ],
          showStudyModal: false,
          subjects: {},
          studying: false,
          currentUserId: null
        }
      },
      computed: {
        expPercentage() {
          if (this.user.next_exp === 0) return 100;
          return Math.min(100, (this.user.exp / this.user.next_exp) * 100);
        }
      },
      async mounted() {
        await this.initLiff();
        // For development without LIFF ID, uncomment below:
        // await this.fetchUserData("DEBUG_USER"); 
      },
      methods: {
        async initLiff() {
          try {
            // liffIdãŒç©ºã®å ´åˆã¯åˆæœŸåŒ–ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            if (!this.liffId || this.liffId === "YOUR_LIFF_ID") {
              console.log("LIFF ID not set. Running in browser mode.");
              // ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒ€ãƒŸãƒ¼IDã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
              this.currentUserId = "U1234567890abcdef1234567890abcdef";
              await this.fetchUserData(this.currentUserId);
              this.loading = false;
              return;
            }

            await liff.init({ liffId: this.liffId });
            if (liff.isLoggedIn()) {
              const profile = await liff.getProfile();
              this.currentUserId = profile.userId;
              await this.fetchUserData(this.currentUserId);
            } else {
              liff.login();
            }
          } catch (err) {
            console.error('LIFF Init Failed', err);
            // Fallback for debug
            this.currentUserId = "DEBUG_USER";
            await this.fetchUserData(this.currentUserId);
          } finally {
            this.loading = false;
          }
        },
        async fetchUserData(userId) {
          try {
            // userIdã‚’ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã©ã§æ¸¡ã™å¿…è¦ãŒã‚ã‚‹ãŒã€
            // å®Ÿéš›ã¯LIFFã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã†ã®ãŒå®‰å…¨ã€‚
            // ã“ã“ã§ã¯ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã¨ã—ã¦Pathãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ¸¡ã™ã€‚
            const response = await fetch(`/api/user/${userId}/status`);
            if (!response.ok) throw new Error('API Error');

            const data = await response.json();
            if (data.status === 'ok') {
              this.user = data.data;
              // Weekly dataãªã©ã¯å¾Œã§å®Ÿè£…
            }
          } catch (e) {
            console.error(e);
            // Mock data on error
            this.user = {
              name: "å‹‡è€…ã‚¢ãƒ«ã‚¹",
              level: 12,
              exp: 1450,
              next_exp: 2000,
              coins: 3500,
              total_hours: 42.5,
              rank_name: "Rank C: ç†Ÿç·´è€…",
              avatar_url: "https://cdn-icons-png.flaticon.com/512/4333/4333609.png"
            };
          }
        },
        openShop() {
          playSound('click');
          alert("ã‚·ãƒ§ãƒƒãƒ—æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™ï¼");
        },
        async openModal() {
          playSound('click');
          this.showStudyModal = true;
          // ç§‘ç›®ãƒªã‚¹ãƒˆå–å¾—
          if (Object.keys(this.subjects).length === 0) {
            try {
              const res = await fetch('/api/study/subjects');
              const json = await res.json();
              if (json.status === 'ok') {
                this.subjects = json.data;
              }
            } catch (e) { console.error(e); }
          }
        },
        async startStudy(subject) {
          playSound('click');
          if (!this.currentUserId) return;

          this.studying = true;
          try {
            const res = await fetch('/api/study/start', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                user_id: this.currentUserId,
                subject: subject
              })
            });
            const json = await res.json();
            if (json.status === 'ok') {
              // æˆåŠŸã—ãŸã‚‰é–‰ã˜ã‚‹ & LINEé–‰ã˜ã‚‹
              liff.closeWindow();
            } else {
              alert("é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: " + json.message);
            }
          } catch (e) {
            alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
          } finally {
            this.studying = false;
            this.showStudyModal = false;
          }
        }
      }
    }).mount('#app')
  </script>
</body>

</html>