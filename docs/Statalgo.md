# アルゴリズム解説 (偏差値計算モデル)

本システムでは、勉強時間を「佐賀県の高校入試」に見立てた偏差値として表現するユニークなアルゴリズムを採用しています。
これは子供たちのモチベーションを高めるための「ゲーミフィケーション」の一環であり、実際の統計データとは異なりますが、学習継続へのインセンティブとなるように設計されています。

## 1. 偏差値計算の仕組み

基本となる偏差値計算式は以下の通りです。

$$
Deviation = \frac{X - \mu}{\sigma} \times 10 + 50
$$

ここで、
*   $X$: ユーザーの学習時間（分）
*   $\mu$ (Mean): 基準となる平均勉強時間
*   $\sigma$ (Std Dev): 基準となる標準偏差

### 定数の設定 (SagaStats)
佐賀県の中学生（J1）をモデルとした架空の母集団を設定しています。

*   **母集団 (POPULATION_J1)**: 7,676人（佐賀県の中学生数を参考に設定）
*   **基準平均 (MEAN_J1)**: 60分/日 (1日あたり期待される平均学習時間)
*   **基準偏差 (STD_J1)**: 45分 (ばらつきの大きさ)

### 期間に応じた補正
1日の計算だけでなく、週間・月間でも適切な偏差値が出るように、統計学的な独立試行を仮定してパラメータを補正しています。

*   **1日**: $\mu = 60$, $\sigma = 45$
*   **週間 (7日間)**: 
    *   $\mu_{weekly} = 60 \times 7 = 420$ 分
    *   $\sigma_{weekly} = 45 \times \sqrt{7} \approx 119$ 分
*   **月間 (30日間)**:
    *   $\mu_{monthly} = 60 \times 30 = 1800$ 分
    *   $\sigma_{monthly} = 45 \times \sqrt{30} \approx 246$ 分

これにより、「毎日コツコツ60分やれば偏差値50」という感覚を維持しつつ、長期的な積み上げを評価できるようになっています。

## 2. 合格判定モデル

算出された偏差値に基づき、佐賀県の高校レベルに当てはめて判定を行います。

| 偏差値 | 判定ランク | イメージ |
|:---|:---|:---|
| 68以上 | **佐賀西高校** | 超トップレベル。かなりの努力が必要。 |
| 60以上 | 致遠館高校 | 上位校。 |
| 55以上 | 佐賀北高校 | 進学校。 |
| 50以上 | 佐賀東高校 | 平均以上。 |
| 45以上 | 佐賀商業高校 | 標準レベル。 |
| 40以上 | 佐賀工業高校 | 専門性志向。 |
| 38以上 | 佐賀北稜高校 | 基礎レベル。 |
| 38未満 | 基礎固めが必要 | もっと頑張ろう。 |

## 3. 「ごぼう抜き」人数の計算

「もし君が全く勉強しなかったら（0分）、何位だったか」と「今の勉強時間での順位」を比較し、その差分を「ごぼう抜き人数」として算出しています。

$$
Overtaken = Rank(0) - Rank(X)
$$

これにより、「今日1時間勉強したおかげで、3000人をごぼう抜きにしたよ！」というポジティブなフィードバックを可能にしています。

---

## 4. 運用に関するQ&A (スプレッドシートの切り替え)

### Q: 月初めにスプレッドシートを変えるべきですか？

**A: 基本的にはその必要はありません。**

現在のプログラム (`services/history.py`) は、`study_log` という1つのシートに記録されたデータを読み込み、プログラム側で「今月の日付かどうか」を判断して集計しています。

*   **自動集計**: プログラムが自動的に `202X-MM-01` 以降のデータを抽出して計算するため、シートを月ごとに分ける必要はありません。
*   **推奨運用**: 
    *   **継続利用**: 同じシート（`study_log`）を使い続けてください。
    *   **データ量**: 数千〜数万行になっても基本的には動作しますが、数年運用して動作が重くなった場合は、古いデータを「study_log_archive_2025」のように別シートに退避（リネームして保存）し、新しい「study_log」シートを空の状態で作ると良いでしょう。
