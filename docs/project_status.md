# プロジェクト進捗と今後のロードマップ

## 1. 実装済み機能 (Current Status)

これまでの開発で、以下の主要機能が実装されています。

### 📚 勉強管理システム
- **機能**: 勉強時間の記録（開始・終了）、時間の自動計算。
- **教科選択**: 勉強開始時に「算数」「国語」などの教科を選択可能。
- **ルール**: 1回あたりの上限を90分に設定。
- **フロー**: 終了時に自動で親へ承認依頼を送信。

### 🧹 お手伝い（ジョブ）システム
- **機能**: タスクの募集、受注、完了報告。
- **管理**: Googleフォームを通じた新規タスクの追加。
- **フロー**: 完了報告 → 親の承認 → 報酬(EXP)付与。

### 🛍️ ショップ・経済システム
- **機能**: 獲得したEXPを使ったアイテム購入リクエスト。
- **フロー**: 購入申請 → 親の承認 → EXP消費（却下時は返金）。
- **データ**: 商品リストはスプレッドシートで管理。

### 👑 管理者ダッシュボード
- **機能**: 「管理」コマンドによる承認待ちタスクの一括表示。
- **UI**: LINEのカルーセル（横スクロール）形式で、勉強・お手伝い・買い物の承認をまとめて処理可能。
- **承認フロー**: 承認時に「誰の」「何のタスク」を「誰が承認したか」を明確に通知。

### 📊 分析・可視化 (Looker Studio連携)
- **機能**: 「状況」コマンドで、管理者および全ユーザーにLooker Studioへのリンクを表示。
- **目的**: 学習時間やEXPの推移をグラフで確認可能。

### 📖 ヘルプ・マニュアル
- **機能**: 「ヘルプ」コマンドで、ユーザー向け・管理者向けの使い方ガイドを表示。

### 🔧 技術的改善
- **リファクタリング**: LINE Flex MessageのJSON定義をコードから分離し、`templates/` ディレクトリで管理。
- **サービス層の分離**: `GSheetService`, `JobService`, `ShopService`, `ApprovalService` など、機能ごとにロジックを分割。
- **エラーハンドリング強化**: 管理機能(`admin.py`)において、テンプレート読み込みエラーや例外発生時に適切にログ出力とユーザー通知を行うよう修正。
- **バグ修正**: ショップ承認時のEXP二重徴収問題、通貨単位表記(円→EXP)の修正、空データ時のエラー回避処理を追加。
- **連打防止**: ボタンの連打による二重処理を防ぐため、デバウンス処理(5秒ロック)と承認状態のチェック(冪等性)を実装。

### 📱 リッチメニュー
- **機能**: LINE画面下部に固定メニューを表示。
- **実装**: LINE Developersコンソールにて設定済み。「勉強開始」「ショップ」「管理」などのコマンドをタップ操作で実行可能。

---

## 2. 今後の改善提案 (Roadmap)

### 短期的な改善 (Short-term)
1.  **入力の堅牢化**
    - Googleフォーム連携部分の自動化（現在はURL案内のみだが、GASを使って自動でシートに取り込むなど）。

### 中期的な改善 (Mid-term)
1.  **状態管理の永続化**
    - **現状**: `app.py` 内の `user_states` 変数で会話状態（例：ジョブ作成中の入力待ち）を管理しているため、サーバーが再起動すると状態がリセットされる。
    - **改善**: データベースやファイル、あるいはRedisなどに一時データを保存するようにする。
2.  **コード構造の整理**
    - **現状**: `app.py` が肥大化しつつある（ルーティングとボットの応答ロジックが混在）。
    - **改善**: Flaskの `Blueprint` 機能を使って、機能ごと（勉強、ジョブ、ショップ）にファイルを分割する。

---

## 3. 抜本的な改革は必要か？ (Is drastic reform needed?)

### 結論: 「家族利用」の範囲なら、今のままで十分運用可能です。

現状のアーキテクチャ（Flask + Google Sheets）は、セットアップが簡単で、データの確認もスプレッドシートを見るだけで済むため、**個人・家族開発においては非常に合理的**です。
ユーザー様の方針として、今後もスプレッドシートをデータベースとして利用し続けることが決定しています。

### 推奨する「プチ改革」
抜本的な作り直しは不要ですが、メンテナンス性を保つために **「`app.py` の分割」** だけは早めにやっておくと、今後の機能追加が楽になります。

#### 構成案
```text
Study_Guardian/
  ├── app.py           (エントリーポイント。設定と起動のみ)
  ├── routes/          (LINEのイベントハンドラを分割)
  │    ├── study.py    (勉強関連の応答)
  │    ├── job.py      (ジョブ関連の応答)
  │    ├── shop.py     (ショップ関連の応答)
  │    └── admin.py    (管理コマンド)
  ├── services/        (ビジネスロジック - 既存)
  └── templates/       (JSONテンプレート - 既存)
```aa
